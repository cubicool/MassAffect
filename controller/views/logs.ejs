<!DOCTYPE html>
<html>
<head>
	<title>MassAffect :: <%= vps %> Logs</title>

	<style>
		body {
			background: #0e1117;
			color: #c9d1d9;
			font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
			margin: 0;
			padding: 0;
		}

		header {
			background: #161b22;
			padding: 16px 24px;
			border-bottom: 1px solid #30363d;
			font-size: 18px;
		}

		.vps-name {
			color: #58a6ff;
		}

		.log-container {
			padding: 20px;
		}

		.log-entry {
			background: #161b22;
			border: 1px solid #30363d;
			border-radius: 6px;
			padding: 12px 16px;
			margin-bottom: 10px;
			transition: background 0.2s ease;
		}

		.log-entry:hover {
			background: #1f2937;
		}

		.ts {
			color: #8b949e;
			font-size: 12px;
		}

		.source {
			color: #3fb950;
			font-size: 12px;
			margin-top: 3px;
			margin-bottom: 3px;
		}

		.message {
			margin-bottom: 0px;
			white-space: pre-wrap;
			word-break: break-word;
		}

		.nginx-log {
			font-size: 14px;
			line-height: 1.4;
		}

		.meta {
			color: #8b949e;
			font-size: 12px;
			margin-top: 4px;
		}

		.ua {
			color: #6e7681;
			font-size: 12px;
			margin-top: 6px;
			word-break: break-word;
		}

		.nginx-line {
			display: flex;
			gap: 6px;
			align-items: baseline;
			min-width: 0; /* important for flex truncation */
		}

		.truncate {
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
			display: block;
			min-width: 0;
			flex: 1;
		}

		.status-200 { color: #3fb950; }
		.status-404 { color: #f85149; }
		.status-500 { color: #ff7b72; }
	</style>
</head>

<body>

<header>
	MassAffect Logs :: <span class="vps-name"><%= vps %></span>

	<% if(source) { %>
		<span style="color:#f85149;">(filtered: <%= source %>)</span>
	<% } %>
</header>

<form method="GET" style="padding: 16px 24px; background:#161b22;">
	<input 
		type="text" 
		name="source" 
		placeholder="Filter by source..."
		value="<%= source || '' %>"
		style="background:#0d1117;color:#c9d1d9;border:1px solid #30363d;padding:6px 10px;border-radius:4px;"
	/>
	<button type="submit" style="margin-left:8px;padding:6px 10px;background:#238636;border:none;border-radius:4px;color:white;">
		Filter
	</button>
</form>

<div class="log-container">
	<% events.forEach(event => { %>
		<%- include("partials/log-entry", { event }) %>
	<% }) %>
</div>

<script>
	const vps = "<%= vps %>";
	const collector = "logs.nginx";
	const activeFilter = "<%= source || "" %>";
	const container = document.querySelector(".log-container");
	const evtSource = new EventSource(`/monitor/stream/${vps}/${collector}`);

	function timeAgo(date) {
		const diffSec = Math.floor((Date.now() - date.getTime()) / 1000);

		if(diffSec < 5) return "just now";
		if(diffSec < 60) return diffSec + "s ago";
		if(diffSec < 3600) return Math.floor(diffSec / 60) + "m ago";
		if(diffSec < 86400) return Math.floor(diffSec / 3600) + "h ago";

		return Math.floor(diffSec / 86400) + "d ago";
	}

	function refreshTimes() {
		document.querySelectorAll("time.ts[datetime]").forEach(el => {
			const iso = el.getAttribute("datetime");
			const date = new Date(iso);

			if(!isNaN(date.getTime())) {
				console.log(`Setting ${el}`);

				el.textContent = timeAgo(date);
			}
		});
	}

	evtSource.onmessage = function(event) {
		const data = JSON.parse(event.data);

		if(data.status === "connected") return;

		if(activeFilter) {
			// crude but effective: skip if filter not in HTML
			if(!data.html.includes(activeFilter)) return;
		}

		const wrapper = document.createElement("div");

		wrapper.innerHTML = data.html;

		container.prepend(wrapper.firstElementChild);

		refreshTimes();
	};

	setInterval(refreshTimes, 10000);
	refreshTimes();
</script>

</body>
</html>
