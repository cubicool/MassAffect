<!DOCTYPE html>
<html>
<head>
	<title>MassAffect :: <%= vps %> Logs</title>

	<style>
		body {
			background: #0e1117;
			color: #c9d1d9;
			font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
			margin: 0;
			padding: 0;
		}

		header {
			background: #161b22;
			padding: 16px 24px;
			border-bottom: 1px solid #30363d;
			font-size: 18px;
		}

		.vps-name {
			color: #58a6ff;
		}

		.log-container {
			padding: 20px;
		}

		.log-entry {
			background: #161b22;
			border: 1px solid #30363d;
			border-radius: 6px;
			padding: 12px 16px;
			margin-bottom: 10px;
			transition: background 0.2s ease;
		}

		.log-entry:hover {
			background: #1f2937;
		}

		.ts {
			color: #8b949e;
			font-size: 12px;
		}

		.source {
			color: #3fb950;
			font-size: 12px;
		}

		.message {
			margin-bottom: 0px;
			white-space: pre-wrap;
			word-break: break-word;
		}

		.nginx-log {
			font-size: 14px;
			line-height: 1.4;
		}

		.meta {
			color: #8b949e;
			font-size: 12px;
			margin-top: 4px;
		}

		.ua {
			color: #6e7681;
			font-size: 12px;
			margin-top: 6px;
			word-break: break-word;
		}

		.nginx-line {
			display: flex;
			gap: 6px;
			align-items: baseline;
			min-width: 0; /* important for flex truncation */
		}

		.truncate {
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
			display: block;
			min-width: 0;
			flex: 1;
		}

		.status-200 { color: #3fb950; }
		.status-404 { color: #f85149; }
		.status-500 { color: #ff7b72; }
	</style>
</head>

<body>

<header>
	MassAffect Logs :: <span class="vps-name"><%= vps %></span>

	<% if (source) { %>
		<span style="color:#f85149;">(filtered: <%= source %>)</span>
	<% } %>
</header>

<form method="GET" style="padding: 16px 24px; background:#161b22;">
	<input 
		type="text" 
		name="source" 
		placeholder="Filter by source..."
		value="<%= source || '' %>"
		style="background:#0d1117;color:#c9d1d9;border:1px solid #30363d;padding:6px 10px;border-radius:4px;"
	/>
	<button type="submit" style="margin-left:8px;padding:6px 10px;background:#238636;border:none;border-radius:4px;color:white;">
		Filter
	</button>
</form>

<div class="log-container">
	<% events.forEach(event => { %>
		<div class="log-entry">

			<div class="ts">
				<%= new Date(event.ts * 1000).toISOString() %>
			</div>

			<div class="source">
				<%= event.metrics?.source || "unknown source" %>
			</div>

			<%
				const metrics = event.metrics || {};
				let template = "partials/raw";

				// Renderer selection logic
				if (metrics.source?.includes("access.log")) {
					template = "partials/nginx";
				}

				// Future examples:
				// if (metrics.source?.includes("error.log")) {
				//     template = "partials/nginx_error";
				// }
				//
				// if (event.collector === "system") {
				//     template = "partials/system";
				// }
			%>

			<%- include(template, { metrics }) %>

		</div>
	<% }) %>
</div>

<script>
	const vps = "<%= vps %>";
	const collector = "logs";
	const activeFilter = "<%= source || "" %>";

	const container = document.querySelector(".log-container");

	const evtSource = new EventSource(
		`/monitor/stream/${vps}/${collector}`
	);

	evtSource.onmessage = function(event) {
		const data = JSON.parse(event.data);

		if (data.status === "connected") return;

		if (activeFilter && !data.metrics?.source?.includes(activeFilter)) {
			return;
		}

		const metrics = data.metrics || {};
		const source = metrics.source || "";

		const div = document.createElement("div");
		div.className = "log-entry";

		let content = "";

		// --- nginx-style render ---
		if (source.includes("access.log")) {
			content = `
				<div class="nginx-line">
					<strong>${metrics.remote_addr || ""}</strong>
					â†’ ${metrics.method || ""}
					<span class="truncate" title="${metrics.path || ""}">
						${metrics.path || ""}
					</span>
				</div>
				<div class="meta">
					Status: ${metrics.status || ""}
					| Bytes: ${metrics.body_bytes_sent || ""}
				</div>
			`;
		}
		// --- raw-style render ---
		else {
			content = `
				<pre class="message">${(metrics.raw || "").trimEnd()}</pre>
			`;
		}

		div.innerHTML = `
			<div class="ts">
				${new Date(data.ts * 1000).toISOString()}
			</div>
			<div class="source">
				${source || "unknown source"}
			</div>
			${content}
		`;

		container.prepend(div);
	};
</script>

</body>
</html>
